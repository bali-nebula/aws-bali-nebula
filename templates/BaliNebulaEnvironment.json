{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This cloud formation template is used to setup the Bali Nebula environment.",
  "Parameters": {
    "BackupBucket": {
      "Description": "The name of the bucket that is used for storing backups.",
      "Type": "String",
      "Default": "craterdog-bali-backups-us-west-2"
    }
  },
  "Resources": {
    "LogReplicationRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "s3.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "LogReplicationPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "s3:Get*",
                    "s3:ListBucket"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}" },
                    { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}/*" }
                  ]
                },
                {
                  "Action": [
                    "s3:ReplicateObject",
                    "s3:ReplicateDelete",
                    "s3:ReplicateTags",
                    "s3:GetObjectVersionTagging"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    { "Fn::Sub": "arn:aws:s3:::${BackupBucket}/*" }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "LogBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "craterdog-bali-logs-${AWS::Region}" },
        "AccessControl": "Private",
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "LogExpiration",
              "ExpirationInDays": 10,
              "NoncurrentVersionExpirationInDays": 1,
              "Status": "Enabled"
            }
          ]
        },
        "ReplicationConfiguration": {
          "Role": { "Fn::GetAtt": [ "LogReplicationRole", "Arn" ] },
          "Rules": [
            {
              "Prefix": "",
              "Destination": {
                "Bucket": { "Fn::Sub": "arn:aws:s3:::${BackupBucket}" },
                "StorageClass": "STANDARD_IA"
              },
              "Status": "Enabled"
            }
          ]
        }
      }
    },
    "LogBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "LogBucket" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AWSCloudTrailAclCheck",
              "Effect": "Allow",
              "Principal": { "Service": "cloudtrail.amazonaws.com" },
              "Action": "s3:GetBucketAcl",
              "Resource": { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}" }
            },
            {
              "Sid": "AWSCloudTrailWrite",
              "Effect": "Allow",
              "Principal": { "Service":"cloudtrail.amazonaws.com" },
              "Action": "s3:PutObject",
              "Resource": { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}/*" },
              "Condition": {
                "StringEquals": {
                  "s3:x-amz-acl": "bucket-owner-full-control"
                }
              }
            }
          ]
        }
      }
    },
    "CloudTrail": {
      "Type": "AWS::CloudTrail::Trail",
      "Properties": {
        "S3BucketName": { "Ref": "LogBucket" },
        "IncludeGlobalServiceEvents": true,
        "EnableLogFileValidation": true,
        "IsMultiRegionTrail": true,
        "IsLogging": "true"
      },
      "DependsOn": ["LogBucketPolicy"]
    },
    "NebulaBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "craterdog-bali-nebula-${AWS::Region}" },
        "AccessControl": "Private"
      }
    }
  }
}
