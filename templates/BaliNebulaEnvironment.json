{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This cloud formation template is used to setup the Bali Nebula environment.",
  "Parameters": {
    "BackupBucket": {
      "Description": "The name of the bucket that is used for storing backups.",
      "Type": "String",
      "Default": "craterdog-bali-logs-us-west-2"
    }
  },
  "Resources": {
    "NebulaDomain": {
      "Type": "AWS::ApiGateway::DomainName",
      "Properties": {
        "RegionalCertificateArn": "arn:aws:acm:us-east-1:821699068808:certificate/066d667f-ec36-486f-9fca-42136deb31bd",
        "DomainName": "bali-nebula.net",
        "EndpointConfiguration" : {
          "Types" : [ "REGIONAL" ]
        }
      }
    },
    "NebulaRouting": {
      "Type" : "AWS::Route53::RecordSet",
      "DependsOn": [ "NebulaDomain" ],
      "Properties" : {
        "Name": "bali-nebula.net.",
        "Comment" : "Route all repository requests to the repository API gateway endpoint,",
        "Type" : "A",
        "HostedZoneName" : "bali-nebula.net.",
        "AliasTarget" : {
          "DNSName": { "Fn::GetAtt": [ "NebulaDomain", "RegionalDomainName" ] },
          "EvaluateTargetHealth" : false,
          "HostedZoneId" : "Z1UJRXOUMOOFQ8"
        }
      }
    },
    "LogReplicationRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "s3.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "LogReplicationPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "s3:Get*",
                    "s3:ListBucket"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}" },
                    { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}/*" }
                  ]
                },
                {
                  "Action": [
                    "s3:ReplicateObject",
                    "s3:ReplicateDelete",
                    "s3:ReplicateTags",
                    "s3:GetObjectVersionTagging"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    { "Fn::Sub": "arn:aws:s3:::${BackupBucket}/*" }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "LogBucket": {
      "Type": "AWS::S3::Bucket",
      "DependsOn": [ "LogReplicationRole" ],
      "Properties": {
        "BucketName": { "Fn::Sub": "craterdog-bali-logs-${AWS::Region}" },
        "AccessControl": "Private",
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls" : true,
          "BlockPublicPolicy" : true,
          "IgnorePublicAcls" : true,
          "RestrictPublicBuckets" : true
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "LogExpiration",
              "ExpirationInDays": 10,
              "NoncurrentVersionExpirationInDays": 1,
              "Status": "Enabled"
            }
          ]
        },
        "ReplicationConfiguration": {
          "Role": { "Fn::GetAtt": [ "LogReplicationRole", "Arn" ] },
          "Rules": [
            {
              "Prefix": "",
              "Destination": {
                "Bucket": { "Fn::Sub": "arn:aws:s3:::${BackupBucket}" },
                "StorageClass": "STANDARD_IA"
              },
              "Status": "Enabled"
            }
          ]
        }
      }
    },
    "LogBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "DependsOn": [ "LogBucket" ],
      "Properties": {
        "Bucket": { "Ref": "LogBucket" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "cloudtrail.amazonaws.com" },
              "Action": "s3:GetBucketAcl",
              "Resource": { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}" }
            },
            {
              "Effect": "Allow",
              "Principal": { "Service": "cloudtrail.amazonaws.com" },
              "Action": "s3:PutObject",
              "Resource": { "Fn::Sub": "arn:aws:s3:::craterdog-bali-logs-${AWS::Region}/*" },
              "Condition": {
                "StringEquals": {
                  "s3:x-amz-acl": "bucket-owner-full-control"
                }
              }
            }
          ]
        }
      }
    },
    "CloudTrailRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "LogReplicationPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": [
                    { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/craterdog/administration:*" }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "CloudTrailLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "DependsOn": ["LogBucketPolicy"],
      "Properties": {
        "LogGroupName": "/craterdog/administration",
        "RetentionInDays": 1
      }
    },
    "CloudTrail": {
      "Type": "AWS::CloudTrail::Trail",
      "DependsOn": [ "LogBucket", "CloudTrailLogGroup" ],
      "Properties": {
        "CloudWatchLogsRoleArn": { "Fn::GetAtt": [ "CloudTrailRole", "Arn" ] },
        "CloudWatchLogsLogGroupArn": { "Fn::GetAtt": [ "CloudTrailLogGroup", "Arn" ] },
        "S3BucketName": { "Ref": "LogBucket" },
        "IncludeGlobalServiceEvents": true,
        "IsMultiRegionTrail": true,
        "IsLogging": "true"
      }
    },
    "EnvironmentBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "craterdog-bali-environment-${AWS::Region}" },
        "AccessControl": "Private",
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls" : true,
          "BlockPublicPolicy" : true,
          "IgnorePublicAcls" : true,
          "RestrictPublicBuckets" : true
        }
      }
    }
  }
}
