{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This template creates the API gateway and S3 bucket needed to serve up Bali Nebula Static Content.",
    "Parameters": {
        "TestColor": {
            "Description": "The color of the environment being used for testing.",
            "Type": "String",
            "Default": "green",
            "AllowedValues" : ["blue", "green"],
            "ConstraintDescription" : "You must specify either 'blue' or 'green'."
        }
    },
    "Conditions": {
        "BlueIsTesting" : {
            "Fn::Equals": [
                {"Ref": "TestColor"},
                "blue"
            ]
        },
        "GreenIsTesting" : {
            "Fn::Equals": [
                {"Ref": "TestColor"},
                "green"
            ]
        }
    },
    "Outputs": {
        "ApiId": {
            "Value": { "Ref": "StaticAPI" }
        }
    },
    "Resources": {
        "StaticAPI": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": "Bali Nebula Static Content",
                "Description": "This API allows a client application to retrieve Bali Nebula static content.",
                "BinaryMediaTypes": [
                    "image~1*"
                ],
                "EndpointConfiguration": { "Types": [ "REGIONAL" ] }
            }
        },
        "TypeResource": {
            "Type": "AWS::ApiGateway::Resource",
            "DependsOn": [ "StaticAPI" ],
            "Properties": {
                "ParentId": { "Fn::GetAtt": [ "StaticAPI", "RootResourceId" ] },
                "RestApiId": { "Ref": "StaticAPI" },
                "PathPart": "{type}"
            }
        },
        "ContentResource": {
            "Type": "AWS::ApiGateway::Resource",
            "DependsOn": [ "TypeResource" ],
            "Properties": {
                "ParentId": { "Ref": "TypeResource" },
                "RestApiId": { "Ref": "StaticAPI" },
                "PathPart": "{content}"
            }
        },
        "ContentMethod": {
            "Type": "AWS::ApiGateway::Method",
            "DependsOn": [ "ContentResource" ],
            "Properties": {
                "RestApiId": { "Ref": "StaticAPI" },
                "ResourceId": { "Ref": "ContentResource" },
                "AuthorizationType": "NONE",
                "ApiKeyRequired": false,
                "HttpMethod": "GET",
                "RequestParameters": {
                    "method.request.path.type": true,
                    "method.request.path.content": true
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200
                    },
                    {
                        "StatusCode": 400
                    },
                    {
                        "StatusCode": 500
                    }
                ],
                "Integration": {
                    "Type": "AWS",
                    "Credentials": { "Fn::GetAtt": [ "StaticRole", "Arn" ] },
                    "IntegrationHttpMethod": "GET",
                    "RequestParameters": {
                        "integration.request.path.type": "method.request.path.type",
                        "integration.request.path.content": "method.request.path.content",
                        "integration.request.header.x-amz-acl": "'authenticated-read'"
                    },
                    "PassthroughBehavior": "WHEN_NO_MATCH",
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200
                        }
                    ],
                    "Uri": "arn:aws:apigateway:us-west-2:s3:path/craterdog-bali-statics-us-west-2/{type}/{content}"
                }
            }
        },
        "StaticDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [ "ContentMethod" ],
            "Properties": {
                "RestApiId": { "Ref": "StaticAPI" }
            }
        },
        "BlueStage": {
            "Type": "AWS::ApiGateway::Stage",
            "DependsOn": [ "StaticDeployment" ],
            "Properties": {
                "DeploymentId": { "Ref": "StaticDeployment" },
                "RestApiId": { "Ref": "StaticAPI" },
                "StageName": "blue",
                "Description" : "This stage deploys the Bali Nebula static content to the blue environment.",
                "Variables" : { "EnvironmentColor": "blue" },
                "TracingEnabled" : false,
                "CacheClusterEnabled" : false,
                "CacheClusterSize" : "0.5"
            }
        },
        "BluePath": {
            "Type": "AWS::ApiGateway::BasePathMapping",
            "DependsOn": [ "BlueStage" ],
            "Properties": {
                "RestApiId": { "Ref": "StaticAPI" },
                "DomainName": "bali-nebula.net",
                "BasePath": {
                    "Fn::If" : [
                        "BlueIsTesting",
                        "test-static",
                        "static"
                    ]
                },
                "Stage": "blue"
            }
        },
        "GreenStage": {
            "Type": "AWS::ApiGateway::Stage",
            "DependsOn": [ "StaticDeployment" ],
            "Properties": {
                "DeploymentId": { "Ref": "StaticDeployment" },
                "RestApiId": { "Ref": "StaticAPI" },
                "StageName": "green",
                "Description" : "This stage deploys the Bali Nebula static content to the green environment.",
                "Variables" : { "EnvironmentColor": "green" },
                "TracingEnabled" : false,
                "CacheClusterEnabled" : false,
                "CacheClusterSize" : "0.5"
            }
        },
        "GreenPath": {
            "Type": "AWS::ApiGateway::BasePathMapping",
            "DependsOn": [ "GreenStage" ],
            "Properties": {
                "RestApiId": { "Ref": "StaticAPI" },
                "DomainName": "bali-nebula.net",
                "BasePath": {
                    "Fn::If" : [
                        "GreenIsTesting",
                        "test-static",
                        "static"
                    ]
                },
                "Stage": "green"
            }
        },
        "StaticRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": { "Service": ["apigateway.amazonaws.com"] },
                            "Action": ["sts:AssumeRole"]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "S3Policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:*"
                                    ],
                                    "Resource": [
                                        "arn:aws:s3:::craterdog-bali-statics-us-west-2/*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        }
    }
}
